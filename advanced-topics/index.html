
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../validation/">
      
      
        <link rel="next" href="../testing/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.8">
    
    
      
        <title>Advanced Topics - Hollow (Netflix OSS)</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ded33207.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Robot:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Robot";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="brown">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-topics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Hollow (Netflix OSS)" class="md-header__button md-logo" aria-label="Hollow (Netflix OSS)" data-md-component="logo">
      
  <img src="../img/logo_white_bg.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hollow (Netflix OSS)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Advanced Topics
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="brown"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="brown"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Netflix/hollow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Hollow (Netflix OSS)" class="md-nav__button md-logo" aria-label="Hollow (Netflix OSS)" data-md-component="logo">
      
  <img src="../img/logo_white_bg.png" alt="logo">

    </a>
    Hollow (Netflix OSS)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Netflix/hollow" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../quick-start/" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../indexing-querying/" class="md-nav__link">
        Indexing/Querying
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../infrastructure/" class="md-nav__link">
        Infrastructure Hooks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../producer-consumer-apis/" class="md-nav__link">
        Producers and Consumers
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tooling/" class="md-nav__link">
        Tooling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data-modeling/" class="md-nav__link">
        Data Modeling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../diving-deeper/" class="md-nav__link">
        Diving Deeper
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../interacting-with-a-dataset/" class="md-nav__link">
        Interacting with a Hollow Dataset
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../data-ingestion/" class="md-nav__link">
        Data Ingestion
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        Validation
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Advanced Topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Advanced Topics
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#schema-parser" class="md-nav__link">
    Schema Parser
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#low-level-input-api" class="md-nav__link">
    Low Level Input API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#determining-populated-ordinals" class="md-nav__link">
    Determining Populated Ordinals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caching" class="md-nav__link">
    Caching
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-api" class="md-nav__link">
    Performance API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hollow-heap-effects" class="md-nav__link">
    Hollow Heap Effects
  </a>
  
    <nav class="md-nav" aria-label="Hollow Heap Effects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#double-snapshots" class="md-nav__link">
    Double Snapshots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-sharding" class="md-nav__link">
    Type Sharding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-longevity" class="md-nav__link">
    Object Longevity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-pooling" class="md-nav__link">
    Memory Pooling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delta-based-producer-input" class="md-nav__link">
    Delta-Based Producer Input
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#in-memory-data-layout" class="md-nav__link">
    In-Memory Data Layout
  </a>
  
    <nav class="md-nav" aria-label="In-Memory Data Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-layout" class="md-nav__link">
    Object Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-layout" class="md-nav__link">
    List Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-layout" class="md-nav__link">
    Set Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map-layout" class="md-nav__link">
    Map Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-key-index-layout" class="md-nav__link">
    Primary Key Index Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hash-index-layout" class="md-nav__link">
    Hash Index Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-memory-mode" class="md-nav__link">
    Shared memory mode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../community/" class="md-nav__link">
        Community
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../acknowledgements/" class="md-nav__link">
        Acknowledgements
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#schema-parser" class="md-nav__link">
    Schema Parser
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#low-level-input-api" class="md-nav__link">
    Low Level Input API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#determining-populated-ordinals" class="md-nav__link">
    Determining Populated Ordinals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#caching" class="md-nav__link">
    Caching
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-api" class="md-nav__link">
    Performance API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hollow-heap-effects" class="md-nav__link">
    Hollow Heap Effects
  </a>
  
    <nav class="md-nav" aria-label="Hollow Heap Effects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#double-snapshots" class="md-nav__link">
    Double Snapshots
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-sharding" class="md-nav__link">
    Type Sharding
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-longevity" class="md-nav__link">
    Object Longevity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-pooling" class="md-nav__link">
    Memory Pooling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delta-based-producer-input" class="md-nav__link">
    Delta-Based Producer Input
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#in-memory-data-layout" class="md-nav__link">
    In-Memory Data Layout
  </a>
  
    <nav class="md-nav" aria-label="In-Memory Data Layout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#object-layout" class="md-nav__link">
    Object Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-layout" class="md-nav__link">
    List Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-layout" class="md-nav__link">
    Set Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#map-layout" class="md-nav__link">
    Map Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primary-key-index-layout" class="md-nav__link">
    Primary Key Index Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hash-index-layout" class="md-nav__link">
    Hash Index Layout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-memory-mode" class="md-nav__link">
    Shared memory mode
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="advanced-topics">Advanced Topics<a class="headerlink" href="#advanced-topics" title="Permanent link">&para;</a></h1>
<p>This section covers few topics in details to give a deep insight into implementation of Hollow.</p>
<h2 id="schema-parser">Schema Parser<a class="headerlink" href="#schema-parser" title="Permanent link">&para;</a></h2>
<p>Hollow schemas can be serialized as Java Strings.  Calling <code>toString()</code> on a <code>HollowSchema</code> will produce a human-readable representation of the schema.  The following shows the String representations of all of the schemas from a <code>Movie</code>/<code>Actor</code> example data model:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>Movie @PrimaryKey(id) {
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    long id;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    int releaseYear;
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    string title;
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    SetOfActor actors;
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>}
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>SetOfActor Set&lt;Actor&gt; @HashKey(firstname, surname);
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>Actor {
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    long id;
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    String firstname;
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    String surname;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>}
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>String {
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    string value;
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>}
</span></code></pre></div>
<p>These representations can be parsed using the <code>HollowSchemaParser</code>, and in turn can be used to initialize the state of a <code>HollowWriteStateEngine</code>:
<div class="language-java highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">String</span><span class="w"> </span><span class="n">allSchemas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// a String containing all schemas</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">List</span><span class="o">&lt;</span><span class="n">HollowSchema</span><span class="o">&gt;</span><span class="w"> </span><span class="n">schemas</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">             </span><span class="n">HollowSchemaParser</span><span class="p">.</span><span class="na">parseCollectionOfSchemas</span><span class="p">(</span><span class="n">allSchemas</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">HollowWriteStateEngine</span><span class="w"> </span><span class="n">initializedWriteEngine</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">             </span><span class="n">HollowWriteStateCreator</span><span class="p">.</span><span class="na">createWithSchemas</span><span class="p">(</span><span class="n">schemas</span><span class="p">);</span>
</span></code></pre></div></p>
<div class="admonition hint">
<p class="admonition-title">Guiding Data Ingestion with a Data Model</p>
<p>For a generic data ingestion mechanism, loading the schemas from a text representation comes in handy.  For example, the <a href="../data-ingestion/#json-to-hollow-adapter">JSON to Hollow adapter</a> requires a <code>HollowWriteStateEngine</code> which is preinitialized with a data model.  The data model can be configured in a text file, and loaded with the <code>HollowSchemaParser</code>.</p>
</div>
<p>Object schema definitions take the following form:
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>ObjectTypeName @PrimaryKey(fieldName1, fieldNameN) {
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>   FieldType1 fieldName1;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>   FieldType2 fieldName2;
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>   ...
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>   FieldTypeN fieldNameN;
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>}
</span></code></pre></div></p>
<p>The primary key definition is optional and should be omitted if no primary key should be defined for a type.</p>
<p>Object schemas may define any of the following field types: <code>int</code>, <code>long</code>, <code>float</code>, <code>double</code>, <code>boolean</code>, <code>string</code>, <code>bytes</code>.  If a field has a type other than these, the field will be interpreted as a <code>REFERENCE</code> to another type of that name.</p>
<div class="admonition warning">
<p class="admonition-title">Lowercase Field Type Declarations</p>
<p>Note that the declarations for each of the inline field types are all lowercase (including <code>string</code>).  An uppercase letter in any of these types will be interpreted as a <code>REFERENCE</code> field to a separate type.</p>
</div>
<p><code>List</code>, <code>Set</code>, and <code>Map</code> types use the following notation:</p>
<ul>
<li><code>ListTypeName List&lt;ElementTypeName&gt;;</code></li>
<li><code>SetTypeName Set&lt;ElementTypeName&gt; @HashKey(elementFieldOne, elementFieldTwo);</code></li>
<li><code>MapTypeName Map&lt;KeyTypeName, ValueTypeName&gt; @HashKey(keyFieldOne, keyFieldTwo);</code></li>
</ul>
<p><code>Set</code> and <code>Map</code> types may optionally define a <a href="../indexing-querying/#hash-keys">hash key</a>.  The hash key definition should be omitted if no hash key should be defined for a type.</p>
<p>Elements, keys, and values in collection record types cannot be inlined.  Whitespace is unimportant when parsing schema definitions.</p>
<h2 id="low-level-input-api">Low Level Input API<a class="headerlink" href="#low-level-input-api" title="Permanent link">&para;</a></h2>
<p>Although Hollow includes a few ready-made data ingestion utilities, other data ingestion utilities can be created.  Adding data into Hollow starts with a <code>HollowWriteStateEngine</code>.  We need to initialize a type state for each schema in our data model:
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">HollowWriteStateEngine</span><span class="w"> </span><span class="n">writeEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowWriteStateEngine</span><span class="p">();</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">HollowObjectSchema</span><span class="w"> </span><span class="n">movieSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectSchema</span><span class="p">(</span><span class="s">&quot;Movie&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">movieSchema</span><span class="p">.</span><span class="na">addField</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">LONG</span><span class="p">);</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">movieSchema</span><span class="p">.</span><span class="na">addField</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">REFERENCE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;String&quot;</span><span class="p">);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="n">movieSchema</span><span class="p">.</span><span class="na">addField</span><span class="p">(</span><span class="s">&quot;releaseYear&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">INT</span><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="n">HollowObjectTypeWriteState</span><span class="w"> </span><span class="n">movieState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectTypeWriteState</span><span class="p">(</span><span class="n">movieSchema</span><span class="p">);</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">writeEngine</span><span class="p">.</span><span class="na">addTypeState</span><span class="p">(</span><span class="n">movieState</span><span class="p">);</span>
</span></code></pre></div></p>
<p>Once weâ€™ve initialized our type states, we can add data into our state engine using HollowWriteRecords:
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">HollowObjectSchema</span><span class="w"> </span><span class="n">stringSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// the String schema</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">HollowObjectSchema</span><span class="w"> </span><span class="n">movieSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// the Movie schema</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">HollowObjectWriteRecord</span><span class="w"> </span><span class="n">titleRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectWriteRecord</span><span class="p">(</span><span class="n">stringSchema</span><span class="p">);</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">HollowObjectWriteRecord</span><span class="w"> </span><span class="n">movieRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectWriteRecord</span><span class="p">(</span><span class="n">movieSchema</span><span class="p">);</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">titleRec</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="s">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The Matrix&quot;</span><span class="p">);</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="kt">int</span><span class="w"> </span><span class="n">titleOrdinal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writeEngine</span><span class="p">.</span><span class="na">addObject</span><span class="p">(</span><span class="s">&quot;String&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">titleRec</span><span class="p">);</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="n">movieRec</span><span class="p">.</span><span class="na">setLong</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="n">movieRec</span><span class="p">.</span><span class="na">setReference</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">titleOrdinal</span><span class="p">);</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="n">movieRec</span><span class="p">.</span><span class="na">setInt</span><span class="p">(</span><span class="s">&quot;releaseYear&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1999</span><span class="p">);</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="n">writeEngine</span><span class="p">.</span><span class="na">addObject</span><span class="p">(</span><span class="s">&quot;Movie&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">movieRec</span><span class="p">);</span>
</span></code></pre></div></p>
<p>Note that referenced records must be added prior to referencing records in order to obtain the referenced ordinals.</p>
<div class="admonition tip">
<p class="admonition-title">Reusing HollowWriteRecords</p>
<p><code>HollowWriteRecord</code>s can be reused -- just be sure to call <code>reset()</code> before populating data from the next record.</p>
</div>
<p>Each schema type has its own <code>HollowTypeWriteState</code> and <code>HollowWriteRecord</code> implementation:
<div class="language-java highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">HollowObjectSchema</span><span class="w"> </span><span class="n">objectSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// an Object schema</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">HollowListSchema</span><span class="w"> </span><span class="n">listSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// a List schema</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">HollowSetSchema</span><span class="w"> </span><span class="n">setSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// a Set schema</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="n">HollowMapSchema</span><span class="w"> </span><span class="n">mapSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// a Map schema</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">HollowObjectTypeWriteState</span><span class="w"> </span><span class="n">objectTypeState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectTypeWriteState</span><span class="p">(</span><span class="n">objectSchema</span><span class="p">);</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="n">HollowListTypeWriteState</span><span class="w"> </span><span class="n">listTypeState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowListTypeWriteState</span><span class="p">(</span><span class="n">listSchema</span><span class="p">);</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="n">HollowSetTypeWriteState</span><span class="w"> </span><span class="n">setTypeState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowSetTypeWriteState</span><span class="p">(</span><span class="n">setSchema</span><span class="p">);</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="n">HollowMapTypeWritestate</span><span class="w"> </span><span class="n">mapTypeState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowMapTypeWriteState</span><span class="p">(</span><span class="n">mapSchema</span><span class="p">);</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="n">HollowObjectWriteRecord</span><span class="w"> </span><span class="n">objectRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectWriteRecord</span><span class="p">(</span><span class="n">objectSchema</span><span class="p">);</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="n">HollowListWriteRecord</span><span class="w"> </span><span class="n">listRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowListWriteRecord</span><span class="p">();</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="n">HollowSetWriteRecord</span><span class="w"> </span><span class="n">setRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowSetWriteRecord</span><span class="p">();</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="n">HollowMapWriteRecord</span><span class="w"> </span><span class="n">mapRec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowMapWriteRecord</span><span class="p">();</span>
</span></code></pre></div></p>
<p>Using this API, it is possible to create a generic data ingestion mechanism from <em>any</em> type of input source.</p>
<h2 id="determining-populated-ordinals">Determining Populated Ordinals<a class="headerlink" href="#determining-populated-ordinals" title="Permanent link">&para;</a></h2>
<p>Many lower-level operations require knowledge of the currently populated ordinals (i.e. those which are not holes), or knowledge of ordinals which were populated in state prior to the last delta application.  We can determine this from any <em>type state</em> in a <code>HollowReadStateEngine</code>.  Both of these are useful, for example, if consumers wish to inspect exactly what has changed.</p>
<p>Each <code>HollowTypeReadState</code> underneath a <code>HollowReadStateEngine</code> contains the methods <code>getPopulatedOrdinals()</code> and <code>getPreviousOrdinals()</code>.  Each of these methods returns a <code>java.util.BitSet</code>.  The contents of returned <code>BitSet</code>s may be inspected, but should never be modified.</p>
<h2 id="caching">Caching<a class="headerlink" href="#caching" title="Permanent link">&para;</a></h2>
<p>Although a lot of effort has gone into minimizing the cost to read Hollow data, there is still inevitably a performance difference between accessing a field in a POJO and accessing a field in Hollow [see also: <a href="#performance-api">Performance API</a>]. In general, this will not be a performance bottleneck, but in some rare cases the performance of tight inner loops may suffer on consumers.</p>
<p>When there is a type with a low cardinality, we can instantiate and cache a POJO implementation for each ordinal, which can be used by consumers in tight inner loops.  This is accomplished by simply passing a <code>Set&lt;String&gt;</code> as the second constructor argument when instantiating a custom-generated Hollow API.  The elements in the Set should be the types to cache.</p>
<div class="admonition danger">
<p class="admonition-title">Avoid Premature Optimization</p>
<p>Caching should be used judiciously.  In all but the tightest of loops, caching will be unnecessary, and can even be detrimental to performance for types with a large cardinality.</p>
</div>
<h2 id="performance-api">Performance API<a class="headerlink" href="#performance-api" title="Permanent link">&para;</a></h2>
<p>A specially generated consumer API allows for traversal of a dataset without ever creating POJOs. Instead, record handles are longs (called Refs). The high bits of a Ref contain a type identifier, and the low bits contain the record's ordinal.</p>
<p>Performance API can be generated using the <code>HollowPerformanceAPIGenerator</code> class like-
<div class="language-java highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">HollowDataset</span><span class="w"> </span><span class="n">dataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SimpleHollowDataset</span><span class="p">.</span><span class="na">fromClassDefinitions</span><span class="p">(</span><span class="n">TestRecord</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  </span><span class="c1">// alternatively, a snapshot from a previous producer run can be used if available</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">HollowPerformanceAPIGenerator</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">        </span><span class="p">.</span><span class="na">withDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">        </span><span class="p">.</span><span class="na">withAPIClassname</span><span class="p">(</span><span class="s">&quot;TestPerfAPI&quot;</span><span class="p">)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="p">.</span><span class="na">withPackageName</span><span class="p">(</span><span class="s">&quot;some.package.name&quot;</span><span class="p">)</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">        </span><span class="p">.</span><span class="na">withDestination</span><span class="p">(</span><span class="s">&quot;/path/to/generated/sources&quot;</span><span class="p">)</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">        </span><span class="p">.</span><span class="na">generateSourceFiles</span><span class="p">();</span>
</span></code></pre></div></p>
<p>For an example of Performance API usage consider this data model-
<div class="language-java highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nd">@HollowPrimaryKey</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="p">)</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestRecord</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="nd">@HollowInline</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">strVal</span><span class="p">;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="nd">@HollowHashKey</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;subVal&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;iSubVal&quot;</span><span class="p">})</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">TestSubRecord</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sub</span><span class="p">;</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">TestRecord</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">strVal</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">...</span><span class="w"> </span><span class="n">subVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">strVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strVal</span><span class="p">;</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">subVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">            </span><span class="n">sub</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TestSubRecord</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">val</span><span class="p">)));</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">    </span><span class="nd">@HollowTypeName</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;TestSubRecord&quot;</span><span class="p">)</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestSubRecord</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">        </span><span class="nd">@HollowInline</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subVal</span><span class="p">;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iSubVal</span><span class="p">;</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">TestSubRecord</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iSubVal</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">subVal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">iSubVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iSubVal</span><span class="p">;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">subVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subVal</span><span class="p">;</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>Performance API usage-
<div class="language-java highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">HollowConsumer</span><span class="w"> </span><span class="n">consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HollowConsumer</span><span class="p">.</span><span class="na">withBlobRetriever</span><span class="p">(</span><span class="n">blobRetriever</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="p">.</span><span class="na">withAnnouncementWatcher</span><span class="p">(</span><span class="n">announcementWatcher</span><span class="p">)</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="p">.</span><span class="na">withGeneratedAPIClass</span><span class="p">(</span><span class="n">TestPerfAPI</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">// in place of the traditional client API</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">TestPerfAPI</span><span class="w"> </span><span class="n">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TestPerfAPI</span><span class="p">)</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="na">getAPI</span><span class="p">();</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kt">long</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">TestRecord</span><span class="p">.</span><span class="na">refForOrdinal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">TestRecord</span><span class="p">.</span><span class="na">getId</span><span class="p">(</span><span class="n">ref</span><span class="p">));</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">TestRecord</span><span class="p">.</span><span class="na">getStrVal</span><span class="p">(</span><span class="n">ref</span><span class="p">));</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="kt">long</span><span class="w"> </span><span class="n">subSetRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">TestRecord</span><span class="p">.</span><span class="na">getSubRef</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="n">HollowPerfReferenceIterator</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">SetOfTestSubRecord</span><span class="p">.</span><span class="na">iterator</span><span class="p">(</span><span class="n">subSetRef</span><span class="p">);</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="k">while</span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">subRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">api</span><span class="p">.</span><span class="na">TestSubRecord</span><span class="p">.</span><span class="na">getSubVal</span><span class="p">(</span><span class="n">subRef</span><span class="p">));</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="p">}</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">subSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">SetOfTestSubRecord</span><span class="p">.</span><span class="na">backedSet</span><span class="p">(</span><span class="n">subSetRef</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="p">.</span><span class="na">TestSubRecord</span><span class="p">::</span><span class="n">getISubVal</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">subSet</span><span class="p">);</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">subSet</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="mi">2002</span><span class="p">));</span>
</span></code></pre></div></p>
<h2 id="hollow-heap-effects">Hollow Heap Effects<a class="headerlink" href="#hollow-heap-effects" title="Permanent link">&para;</a></h2>
<h3 id="double-snapshots">Double Snapshots<a class="headerlink" href="#double-snapshots" title="Permanent link">&para;</a></h3>
<p>At times, a new state may be produced to which there is no available delta from the previous state.  When this <em>broken delta chain</em> scenario occurs, consumers will by default attempt to load a snapshot to the latest state.  If a consumer loads a snapshot when it currently has a state loaded for the same dataset, we call this a <em>double snapshot</em>.  Double snapshots result in a doubling of the heap usage of your dataset.  This is because Hollow assumes that consumers may be actively using the current state, and it therefore must retain the current state to provide data while the next state is loaded.  Only after the next state is fully loaded can the old state be dropped.</p>
<p>If using the <a href="../producer-consumer-apis/#the-hollowconsumer"><code>Hollow Consumer</code></a>, you can configure consumers to never attempt a double snapshot.  This is accomplished with a custom <code>DoubleSnapshotConfig</code>.  In this case, you should check for 'stuck' clients in a <code>RefreshListener</code>, so that you may take the appropriate operational action.</p>
<p>If a dataset is large, double snapshots should be avoided for performance reasons.  Double snapshots can be entirely avoided by <a href="../producer-consumer-apis/#restoring-at-startup">restoring</a> a <code>HollowWriteStateEngine</code> at producer initialization time, and, if necessary, using the <a href="../tooling/#patching"><code>HollowStateDeltaPatcher</code></a> to operationally fill lost or missing deltas in the event an unforeseen issue occurs.</p>
<h3 id="type-sharding">Type Sharding<a class="headerlink" href="#type-sharding" title="Permanent link">&para;</a></h3>
<p>During a delta transition each individual record type builds the entire next state of the type in memory while the current state is retained to answer requests.  This means that the memory pool Hollow reserves needs to be large enough to compose an extra copy of the largest type.  This is a miniaturized version of the <a href="./#double-snapshots">double snapshot</a> problem.</p>
<p>To address this problem, large types can be transparently sharded into smaller individual chunks, each of which updates independently.  The effect of this feature is that Hollow only needs to retain a large enough memory pool to update the largest <em>chunk</em> across all types.</p>
<p>Type sharding can be specified in two ways:  </p>
<ul>
<li>The recommended way is to specify a target max type shard size via a call to <code>setTargetMaxTypeShardSize(long bytes)</code> on a <code>HollowWriteStateEngine</code> prior to writing the first snapshot.  With this call, the number of shards will be automatically calculated based on the target excess memory pool size.</li>
<li>Additionally, the number of shards for a type can be explicitly specified by annotating a POJO with the <code>@HollowShardLargeType</code> annotation when using the <a href="../data-ingestion/#hollowobjectmapper"><code>HollowObjectMapper</code></a> for data ingestion.  This can be useful if rapid growth is anticipated in a type.</li>
</ul>
<p>Within a continuous delta chain, the type sharding configuration cannot be changed.  When a producer <a href="../producer-consumer-apis/#restoring-at-startup">restores</a> the previously produced state at startup, then the restored <code>HollowWriteStateEngine</code> will always retain the sharding configuration of the prior state rather than recalculating based on the current size of each type.  Consequently, if the changes in a dataset over time results in a type sharding configuration which is highly suboptimal, it is recommended to start a new delta chain, which may require a double snapshot on all consumers, a simultaneous restart of all consumers, or a new <a href="../infrastructure/#blob-namespaces">blob namespace</a> to which consumers can migrate over a period of time.</p>
<div class="admonition warning">
<p class="admonition-title">Backwards Compatibility</p>
<p>Type sharding is new in v2.1.0.  Consumers can read blobs produced by producers v2.1.0 and later <em>as long as type sharding is disabled</em>.
If you are sure that all consumers are using v2.1.0 or later, it is safe to turn on type sharding.</p>
<p>In order to avoid causing issues for early adopters, the default target max type shard size is currently set to <code>Long.MAX_VALUE</code>.  At a later time,
this default will be changed to 25MB.</p>
</div>
<h3 id="object-longevity">Object Longevity<a class="headerlink" href="#object-longevity" title="Permanent link">&para;</a></h3>
<p>A Hollow object returned from a generated API contains a reference to the Hollow data store, and an ordinal.  For this reason, if a reference to a Hollow object is retained by the consumer for an extended period of time, and the underlying record changes unexpected results may begin to be returned from these references.  We call Hollow objects which were obtained from a no longer current state stale references.</p>
<p>It is best practice to <strong>never</strong> cache Hollow objects.  However, if it somehow <em>cannot</em> be guaranteed that Hollow Objects will never be cached at the consumer, and guaranteed protection against accidentally cached objects is necessary, then <em>object longevity</em> can be enabled.</p>
<p>With object longevity, Hollow objects will, after an update, be backed by a reserved copy of the data at the time the reference was created.  This guarantees that even if a reference is held for a long time, it will continue to return the same data when interrogated.</p>
<p>When object longevity is defined, Two durations are defined:</p>
<ul>
<li>a grace period, and</li>
<li>a usage detection period.  </li>
</ul>
<p>The grace period is defined by its duration, in milliseconds, after a reference becomes stale.  During the grace period, usage of stale references is acceptable.  The usage detection period is defined by its duration, in milliseconds, after the grace period has expired.  During the usage detection period, usage of stale references is unexpected, but will not result in failed interrogations of Hollow objects.  After the usage detection period expires, data will be dropped if no usage was detected in the usage detection period.  If stale references are interrogated <em>after</em> their backing data is dropped, then Exceptions will be thrown.</p>
<p>The <code>ObjectLongevityConfig</code>, injected into the <code>HollowConsumer</code> constructor, contains a few methods which are used to configure object longevity behavior:</p>
<ul>
<li><code>boolean enableLongLivedObjectSupport()</code>: Whether or not object longevity is enabled.</li>
<li><code>long gracePeriodMillis()</code>: If object longevity is enabled, this returns the number of milliseconds before the usage of stale objects gets flagged.</li>
<li><code>long usageDetectionPeriodMillis()</code>: If long-lived object support is enabled, this defines the number of milliseconds, after the grace period, during which data is still available in stale references, but usage will be flagged.</li>
<li><code>boolean dropDataAutomatically()</code>: Returns whether or not to drop data behind stale references after the grace period + usage detection period has elapsed, as long as no usage was detected during the usage detection period.  This can be used to avoid memory leaks when long lived object support is enabled and stale references are cached, but unused.</li>
<li><code>boolean forceDropData()</code>: Returns whether or not to drop data behind stale references after the grace period + usage detection period has elapsed, even if usage was detected during the usage detection period.  This can be used to avoid memory leaks when long lived object support is enabled and stale references are cached and used.</li>
</ul>
<p>Your implementation of the <code>ObjectLongevityConfig</code> may be backed by a dynamic configuration and safely change on live running consumers.  For example, <code>forceDropData()</code> may be operationally useful for boxes that are exhibiting memory leaks due to non-critical cached Hollow objects.</p>
<div class="admonition hint">
<p class="admonition-title">How It Works</p>
<p>When enabled, object longevity is achieved using the <code>HollowHistory</code> data structure, which results in a minimal heap overhead.</p>
</div>
<h3 id="memory-pooling">Memory Pooling<a class="headerlink" href="#memory-pooling" title="Permanent link">&para;</a></h3>
<p>Under normal operation, Hollow pools and reuses memory to minimize GC effects while updating data.  This pool of memory is kept as arrays on the heap. Each array in the pool has a fixed length.  When a long array or a byte array is required in Hollow, it will stitch together pooled array segments as a <code>SegmentedByteArray</code> or <code>SegmentedLongArray</code>.  These classes encapsulate the details of treating segmented arrays as contiguous ranges of values.</p>
<p>In shared-memory mode (only applicable to data consumers), Hollow uses a <code>BlobByteBuffer</code> abstraction which is basically an array of Java's <code>MappedByteBuffer</code>s stitched together to serve as one contiguous <code>ByteBuffer</code>.
During initial load a snapshot file is mmap-ed to virtual memory as a single <code>BlobByteBuffer</code>, and other <code>BlobByteBuffer</code>s are created as views into the underlying <code>BlobByteBuffer</code> to access parts of the Hollow dataset. Beyond an initial snapshot load, delta applications are currently not supported.</p>
<h2 id="delta-based-producer-input">Delta-Based Producer Input<a class="headerlink" href="#delta-based-producer-input" title="Permanent link">&para;</a></h2>
<p>The <a href="../getting-started/">Getting Started</a> section of this documentation describes a producer which every so often reads the <em>entire dataset</em> from some source of truth, re-adds all records to a <code>HollowWriteStateEngine</code>, then produces a delta based on the automatically discovered differences in the dataset since the prior cycle.  It is possible, however, that a producer may <em>receive</em> an incoming stream of events which directly indicate the changes to a dataset, obviating the need to scan through the entire source of truth and re-add the entire dataset on each cycle.</p>
<p>If desired, a <code>HollowWriteStateEngine</code>â€™s state can be explicitly modified, rather than recreated, each cycle.  We start such a cycle by re-adding all of the records from the previous cycle to the state engine:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">HollowWriteStateEngine</span><span class="w"> </span><span class="n">writeEngine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// the state engine</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="n">writeEngine</span><span class="p">.</span><span class="na">prepareForNextCycle</span><span class="p">();</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">writeEngine</span><span class="p">.</span><span class="na">addAllObjectsFromPreviousCycle</span><span class="p">();</span>
</span></code></pre></div>
<p>Weâ€™ll also need an indexed <code>HollowReadStateEngine</code>, which is updated in lock-step with the <code>HollowWriteStateEngine</code>.  The index can be used to retrieve the ordinals of records to be replaced.  These ordinals can be removed from the <code>HollowWriteStateEngine</code>:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">HollowObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HollowObjectMapper</span><span class="p">(</span><span class="n">writeEngine</span><span class="p">);</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">HollowPrimaryKeyIndex</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">                       </span><span class="k">new</span><span class="w"> </span><span class="n">HollowPrimaryKeyIndex</span><span class="p">(</span><span class="n">readEngine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Movie&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;id&quot;</span><span class="p">);</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">HollowTypeWriteState</span><span class="w"> </span><span class="n">movieTypeState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writeEngine</span><span class="p">.</span><span class="na">getTypeState</span><span class="p">(</span><span class="s">&quot;Movie&quot;</span><span class="p">);</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">List</span><span class="o">&lt;</span><span class="n">MovieUpdateEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eventBatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// a batch of events</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="k">for</span><span class="p">(</span><span class="n">MovieUpdateEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">eventBatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">oldOrdinal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="na">getMatchingOrdinal</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getMovie</span><span class="p">().</span><span class="na">getId</span><span class="p">());</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="n">movieTypeState</span><span class="p">.</span><span class="na">removeOrdinalFromThisCycle</span><span class="p">(</span><span class="n">oldOrdinal</span><span class="p">);</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="n">mapper</span><span class="p">.</span><span class="na">addObject</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getMovie</span><span class="p">());</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="p">}</span>
</span></code></pre></div>
<div class="admonition danger">
<p class="admonition-title">Watch out for Duplicates</p>
<p>Be careful, this process assumes that no two events will have the same movie ID in the same cycle.  You'll want to dedup the <code>eventBatch</code>.</p>
</div>
<p>This process may leave orphaned records around, since the call to <code>removeOrdinalFromThisCycle()</code> doesnâ€™t remove any referenced records.  To solve this, the <a href="../tooling/#transitive-set-traverser"><code>TransitiveSetTraverser</code></a> can be used:
<div class="language-java highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">List</span><span class="o">&lt;</span><span class="n">MovieUpdateEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="n">eventBatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">/// a batch of events</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1">/// find the Movie ordinals to remove</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">BitSet</span><span class="w"> </span><span class="n">removedMovieOrdinals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BitSet</span><span class="p">();</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="k">for</span><span class="p">(</span><span class="n">MovieUpdateEvent</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">eventBatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w"> Â Â Â </span><span class="kt">int</span><span class="w"> </span><span class="n">oldOrdinal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx</span><span class="p">.</span><span class="na">getMatchingOrdinal</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getMovie</span><span class="p">().</span><span class="na">getId</span><span class="p">());</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w"> Â Â Â </span><span class="n">removedMovieOrdinals</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">oldOrdinal</span><span class="p">);</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="p">}</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="c1">/// initially the removal selection includes just Movies</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">BitSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">removeRecords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="n">removeRecords</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;Movie&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">removedMovieOrdinals</span><span class="p">);</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="c1">/// expand the selection to include any records referenced by selected Movies</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="n">TransitiveSetTraverser</span><span class="p">.</span><span class="na">addTransitiveMatches</span><span class="p">(</span><span class="n">readEngine</span><span class="p">,</span><span class="w"> </span><span class="n">removeRecords</span><span class="p">);</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="c1">/// but don&#39;t include records which are also referenced by unselected movies</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="n">TransitiveSetTraverser</span><span class="p">.</span><span class="na">removeReferencedOutsideClosure</span><span class="p">(</span><span class="n">readEngine</span><span class="p">,</span><span class="w"> </span><span class="n">removeRecords</span><span class="p">);</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="c1">/// remove everything in the selection</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="k">for</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">BitSet</span><span class="o">&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">removeRecords</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w"> Â Â Â </span><span class="n">HollowTypeWriteState</span><span class="w"> </span><span class="n">typeState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">writeEngine</span><span class="p">.</span><span class="na">getTypeState</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w"> Â Â Â </span><span class="kt">int</span><span class="w"> </span><span class="n">removeOrdinal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">nextSetBit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w"> Â Â Â </span><span class="k">while</span><span class="p">(</span><span class="n">removeOrdinal</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w"> Â Â Â Â Â Â Â </span><span class="n">typeState</span><span class="p">.</span><span class="na">removeOrdinalFromThisCycle</span><span class="p">(</span><span class="n">removeOrdinal</span><span class="p">);</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w"> Â Â Â Â Â Â Â </span><span class="n">removeOrdinal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">nextSetBit</span><span class="p">(</span><span class="n">removeOrdinal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w"> Â Â Â </span><span class="p">}</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="p">}</span>
</span></code></pre></div></p>
<p>In the above code, each of the <code>Movie</code> ordinals to be replaced are added to a <code>BitSet</code>.  Then, the <code>TransitiveSetTraverser</code> is used to expand the collection of selected records by adding any records referenced by the selected <code>Movies</code>.  Then, the <code>TransitiveSetTraverser</code> is again used to deselect any child records which are also referenced by other Movies which were not selected for removal.  Finally, the selection is actually removed from the <code>HollowWriteStateEngine</code>.</p>
<h2 id="in-memory-data-layout">In-Memory Data Layout<a class="headerlink" href="#in-memory-data-layout" title="Permanent link">&para;</a></h2>
<p>Each record in Hollow begins with a fixed-length number of bits.  At the lowest level, these bits are held in long arrays using the class <code>FixedLengthElementArray</code>.  This class allows for storage and retrieval of fixed-length data in a range of bits.  For example, if a <code>FixedLengthElementArray</code> was queried for the 6-bit value starting at bit 7 in the following example range of bits:</p>
<p><img alt="Bit String" src="../img/memlayout-bitstring.png" /></p>
<p>The value <code>100100</code> in binary, or <code>36</code> in base 10, would be returned.</p>
<h3 id="object-layout">Object Layout<a class="headerlink" href="#object-layout" title="Permanent link">&para;</a></h3>
<p>An <code>OBJECT</code> record is a fixed set of strongly typed fields.  Each field is represented by a fixed-length number of bits.  Each record is represented by a fixed length number of bits equal to the sum of the bits required to represent each fields.  For each type, all fields of all records are packed into a single <code>FixedLengthElementArray</code>.  No bookkeeping data structures are required to locate a record -- the start bit for each record can is located by simply multiplying the number of bits per record times the recordâ€™s ordinal.</p>
<p><img alt="Object Layout" src="../img/memlayout-object.png" /></p>
<p>The number of bits used to represent a field which is one of the types (<code>INT</code>, <code>LONG</code>, <code>REFERENCE</code>) is exactly equal to the number of bits required to represent the maximum value contained in the field across all records.  The values for <code>INT</code> and <code>LONG</code> fields are represented using zig-zag encoding, so that smaller absolute values require fewer bits.  The values for <code>REFERENCE</code> fields are encoded as the referenced recordâ€™s ordinal, which along with the referenced type (from the schema) is sufficient to identify and locate the referenced record.</p>
<p>32 bits are used to represent a <code>FLOAT</code>, and 64 bits are used to represent a <code>DOUBLE</code>.</p>
<p><code>STRING</code> and <code>BYTES</code> fields each get a separate byte array, into which the values for all records are packed.  The fixed-length value in these fields are offsets into the fieldâ€™s byte array where the recordâ€™s value ends.  In order to determine the begin byte for the record with ordinal n, the offset encoded into the record with ordinal (n-1) is read.  The number of fixed length bits used to represent the offsets is exactly equal to the number of number of bits required to represent the maximum offset, plus one.</p>
<p>Each field type may be assigned a null value.  For <code>INT</code>, <code>LONG</code>, and <code>REFERENCE</code> fields, null is encoded as a value with all ones.  For <code>FLOAT</code> and <code>DOUBLE</code> fields, null is encoded as special bit sequences.  For <code>STRING</code> and <code>BYTES</code> fields, null is encoded by setting a designated null bit at the beginning of each field, followed by the end offset of the last populated value for that field.</p>
<h3 id="list-layout">List Layout<a class="headerlink" href="#list-layout" title="Permanent link">&para;</a></h3>
<p>A <code>LIST</code> is an ordered collection of records of a specific type.  <code>LIST</code> types are represented with two FixedLengthElementArrays.  We can refer to these arrays as the <em>offset array</em> and the <em>element array</em>.</p>
<p>Each <code>LIST</code> type contains a single <em>element array</em> into which the references to elements for all records are packed.  References are encoded as the ordinals of the element records, which is sufficient to identify and locate the record.  Each reference is represented using a fixed number of bits equal to the number of bits required to represent the maximum referenced ordinal across all records.  Each record is represented with a contiguous range of elements in the <em>element array</em>.  </p>
<p>The <em>offset array</em> contains fixed-length offsets into the element array where the recordâ€™s elements end.  In order to determine the begin element for the record with ordinal n, the end value for the element (n-1) is read.  </p>
<p><img alt="List Layout" src="../img/memlayout-list.png" /></p>
<p>Elements in a <code>LIST</code> record may not be null.</p>
<h3 id="set-layout">Set Layout<a class="headerlink" href="#set-layout" title="Permanent link">&para;</a></h3>
<p>A <code>SET</code> is an unordered collection of records of a specific type.  The records for <code>SET</code> elements are hashed into an open-addressed hash table.  <code>SET</code> types are represented with two <code>FixedLengthElementArrays</code>.  We can refer to these arrays as the <em>offset array</em> and the <em>bucket array</em>.</p>
<p>Each <code>SET</code> element contains a single <em>bucket array</em> into which the references to elements for all records are packed.  Each record is represented with a contiguous range of buckets in the <em>bucket array</em>.  The range of buckets for each record will contain an open-addressed hash table, with a linear probing hash collision resolution strategy.  The number of buckets for each record will be a power of two, and will be large enough such that all elements for the record will fit into those buckets with a load factor no greater than 70%.  Each bucket is represented using a fixed number of bits equal to the number of bits required to represent the maximum referenced ordinal across all records.  A populated bucket is encoded as the ordinal of the referenced record in that bucket.  To represent empty buckets, a sentinel value equal to all ones in binary is reserved.</p>
<p>The <em>offset array</em> contains two fixed-length fields per record:  the size of the set, and the offset to the bucket where the recordâ€™s data ends.  Each of these fields is encoded using a fixed number of bits equal to the number of bits required to represent the fieldâ€™s maximum value across all records.</p>
<p><img alt="Set Layout" src="../img/memlayout-set.png" /></p>
<p>Elements in a <code>SET</code> record may not be null.</p>
<h3 id="map-layout">Map Layout<a class="headerlink" href="#map-layout" title="Permanent link">&para;</a></h3>
<p>A <code>MAP</code> is an unordered collection of key/value pairs, where each key is a specific type, and each value type is a specific type.  The records for MAP elements are hashed into an open-addressed hash table.  <code>MAP</code> types are represented with two <code>FixedLengthElementArrays</code>.  We can refer to these arrays as the <em>offset array</em> and the <em>bucket array</em>.</p>
<p>Each <code>MAP</code> type contains a single bucket array into which the references to keys and values for all records are packed.  Each record is represented with a contiguous range of buckets in the <em>bucket array</em>.  The range of buckets for each record will contain an open-addressed hash table, with a linear probing hash collision resolution strategy.  The number of buckets for each record will be a power of two, and will be large enough such that all key/value pairs for the record will fit into those buckets with a load factor no greater than 70%.  Each bucket is represented using a fixed number of bits equal to the number of bits required to represent the maximum referenced key ordinal, plus the number of bits required to represent the maximum referenced value ordinal.  A populated bucket contains two fixed length fields: the first field contains the ordinal of the referenced key, and the second field contains the ordinal of the referenced value.  Empty buckets are represented with a key field containing a reserved sentinel value equal to all ones in binary.</p>
<p>The <em>offset array</em> contains two fixed-length fields per record:  the size of the map, and the offset to the bucket where the recordâ€™s data ends.  Each of these fields is encoded using a fixed number of bits equal to the number of bits required to represent the fieldâ€™s maximum value across all records.</p>
<p><img alt="Map Layout" src="../img/memlayout-map.png" /></p>
<p>A <code>MAP</code> cannot contain null keys or values.</p>
<h3 id="primary-key-index-layout">Primary Key Index Layout<a class="headerlink" href="#primary-key-index-layout" title="Permanent link">&para;</a></h3>
<p>A primary key index is a single <code>FixedLengthElementArray</code>, which represents an open-addressed hash table of pointers to records of the given type.  The hash of each record is derived based on the fields designated in the primary key.  Each bucket in the hash table is represented using a fixed number of bits equal to the number of bits required to represent the maximum ordinal of the indexed type.  A populated bucket is encoded as the ordinal of the referenced record in that bucket.  To represent empty buckets, a sentinel value equal to all ones in binary is reserved.</p>
<p>When queried with a key, the index will hash the key, look in the corresponding bucket to find the ordinal of a record which also hashes to this key, then compare the referenced recordâ€™s key to the query.  When a matching record is found, the ordinal at that bucket is returned as the match.  Collisions are resolved with linear probing.  If after linear probing an empty bucket is encountered, no such record exists in the dataset.</p>
<h3 id="hash-index-layout">Hash Index Layout<a class="headerlink" href="#hash-index-layout" title="Permanent link">&para;</a></h3>
<p>A hash index is uses two <code>FixedLengthElementArrays</code>.  These arrays can be referred to as the <em>match array</em> and the <em>select array</em>.  The <em>match array</em> is an open-addressed hash table and contains buckets.  Like a primary key index, the match array does not re-encode the values of keys.  Instead, it retains pointers to existing records which may be used to retrieve the hashed keys.</p>
<p>Unlike a primary key index, it may not be sufficient to retain a single pointer to the indexed type and extract the hashed key from that record -- each record in a hash index may match multiple keys.  Instead, we retain 1-n pointers.  Each pointer will indicate a record through which one or more of the key fields may be unambiguously retrieved.  If multiple key fields may be unambiguously traversed to via a single type, then only a single pointer for the field group will be retained per bucket.  </p>
<p>Consider a scenario in which a hash index is used to index Movies by the nationalities and birth year of actors.  For the key <code>[â€œBritishâ€, 1972]</code>, the corresponding entry in the match array may contain a pointer to the <code>Actor</code> record for Idris Elba.  Although the record points to a specific <code>Actor</code>, the matching records for this entry will contain movies starring any British Actor born in 1972.</p>
<p>Each pointer field in the match array bucket references a specific type, and is encoded as the ordinal to which the bucket refers.  Each is represented using a fixed number of bits equal to the maximum ordinal in the referenced type.</p>
<p>In addition to pointers which allow us to look up the matching key, each bucket in the <em>match array</em> includes the number of matching records, and an offset into the <em>select array</em>.  The <em>select array</em> contains lists of ordinals to matching records.</p>
<p>When queried with a key, the index will hash the key, then look to the corresponding bucket in the <em>match array</em>.  The match pointers are used to compare the queried key with the matching key.  If a match is found, then the corresponding entries in the select array are returned as a <code>HollowHashIndexResult</code>.  Collisions are resolved with linear probing.  If after linear probing an empty bucket is encountered in the match array, no such record exists in the dataset.</p>
<h3 id="shared-memory-mode">Shared memory mode<a class="headerlink" href="#shared-memory-mode" title="Permanent link">&para;</a></h3>
<p>Traditionally, an entire Hollow dataset is loaded in the JVM heap. While this approach has its advantages, it also imposes eager loading of the underlying data and limits the data size to size of available physical memory. An alternative approach is to use memory mapping to map Hollow data to virtual memory and then eagerly or lazily load data into off-heap physical memory. Eager loading would memory lock the dataset and provide similar performance guarantee as traditional on-heap Hollow. Lazy loading would defer loading data to physical memory to when data is accessed (page fault would be incurred which would load 4k sized pages to physical memory, hot data would be retained in physical memory) thereby enabling faster application initialization and support for TB-scale datasets. Mapping Hollow data to shared memory also allows for memory deduplication across Hollow consumers on the same machine.</p>
<p>The shared memory implementation is largely future work, but a limited shared-memory based lazy load functionality has been implemented. When configured for shared memory mode, a consumer will perform an initial snapshot load, it will not apply delta transitions, and data structures tracking indices live on-heap. This limited functionality can be useful for local debugging with large Hollow datasets.</p>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Netflix/hollow" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://gitter.im/Netflix/hollow" target="_blank" rel="noopener" title="gitter.im" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M66.4 322.5H16V0h50.4v322.5zM166.9 76.1h-50.4V512h50.4V76.1zm100.6 0h-50.4V512h50.4V76.1zM368 76h-50.4v247H368V76z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.code.copy", "navigation.indexes", "navigation.instant", "navigation.top", "navigation.tracking", "search.share", "search.highlight", "search.suggest"], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51198bba.min.js"></script>
      
    
  </body>
</html>